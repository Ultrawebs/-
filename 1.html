<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sports | StreamX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Google Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Auth script -->
    <script src="auth.js"></script>

    <!-- JW Player -->
    <script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>

    <style>
      /* Player popup styling */
      #player-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 20px;
      }
      #close-player {
        margin-top: 15px;
        background: #ff4444;
        border: none;
        color: #fff;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        letter-spacing: 0.5px;
      }
      #close-player:hover {
        background: #ff2222;
      }
    </style>
  </head>

  <body>
    <div id="header-placeholder"></div>

    <div class="header2">
      <div class="header2-container">
        <input
          type="search"
          id="searchBar"
          placeholder="Search matches, teams, events..."
          aria-label="Search matches"
        />
      </div>
    </div>

    <main>
      <div id="allCategoriesContainer"></div>
      <p id="message" style="text-align: center; color: #bbb"></p>
    </main>

    <div id="footer-container"></div>

    <!-- JW Player Popup -->
    <div id="player-popup">
      <div id="player-container" style="width: 90%; max-width: 900px;"></div>
      <button id="close-player">Close</button>
    </div>

    <!-- Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const allCategoriesContainer = document.getElementById("allCategoriesContainer");
        const searchBar = document.getElementById("searchBar");

        // Load header & footer
        fetch("header.html").then(r => r.text()).then(d => document.getElementById("header-placeholder").innerHTML = d);
        fetch("footer.html").then(r => r.text()).then(d => document.getElementById("footer-container").innerHTML = d);

        function formatStartTime(str) {
          if (!str) return "-";
          try {
            const date = new Date(str);
            return isNaN(date) ? str : date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          } catch {
            return str;
          }
        }

        function showErrorMessage(message) {
          const existingMsg = document.querySelector(".error-message");
          if (existingMsg) existingMsg.remove();
          const msg = document.createElement("div");
          msg.className = "error-message";
          Object.assign(msg.style, {
            position: "fixed",
            bottom: "20px",
            left: "50%",
            transform: "translateX(-50%)",
            background: "rgba(255,0,0,0.8)",
            color: "#fff",
            padding: "10px 20px",
            borderRadius: "4px",
            zIndex: "10000",
            maxWidth: "90%",
            textAlign: "center",
            whiteSpace: "nowrap",
          });
          msg.textContent = message;
          document.body.appendChild(msg);
          setTimeout(() => msg.remove(), 3000);
        }

        // ðŸ”¹ JW Player Stream Popup
        function playChannel(match) {
          const streamUrl = match.adfree_url ?? match.dai_url;
          if (!streamUrl) return showErrorMessage("No live stream available for this match.");
          if (!/\.(mp4|m3u8)(\?|$)/i.test(streamUrl)) return showErrorMessage("Unsupported stream format.");

          const popup = document.getElementById("player-popup");
          popup.style.display = "flex";

          jwplayer("player-container").setup({
            file: streamUrl,
            width: "100%",
            aspectratio: "16:9",
            autostart: true,
            hlshtml: true,
            image: match.src || "https://placehold.co/600x375?text=Match+Preview",
            abouttext: "Ultrawebs(HM)",
            aboutlink: "https://linktr.ee/ultrawebs",
            logo: {
              file: "https://media.formula1.com/image/upload/f_auto,c_limit,w_285,q_auto/f_auto/q_auto/fom-website/etc/designs/fom-website/images/F1_75_Logo",
              position: "bottom-right",
              margin: "20",
              hide: "false",
              size: "05%",
            },
            playbackRateControls: true,
            cast: { appid: "CC1AD845" },
            airplay: true,
          });

          jwplayer("player-container").on("complete", function () {
            popup.style.display = "none";
            jwplayer("player-container").stop();
          });
        }

        document.getElementById("close-player").addEventListener("click", () => {
          document.getElementById("player-popup").style.display = "none";
          jwplayer("player-container").stop();
        });

        // ðŸ”¹ Create Match Card
        function createMatchCard(match) {
          const card = document.createElement("div");
          card.className = "movie-card";
          card.tabIndex = "0";

          card.addEventListener("click", () => playChannel(match));

          const poster = document.createElement("img");
          poster.src = match.src || "https://placehold.co/600x375?text=No+Image";
          poster.alt = match.title || "Match Image";

          const overlay = document.createElement("div");
          overlay.className = "overlay";

          const title = document.createElement("div");
          title.className = "title";
          title.textContent = match.title || "Untitled Match";

          const teams = document.createElement("div");
          teams.className = "teams";
          if (match.team_1 && match.team_2) teams.textContent = `${match.team_1} vs ${match.team_2}`;
          else if (match.match_name) teams.textContent = match.match_name;

          const event = document.createElement("div");
          event.className = "event";
          event.textContent = match.event_name || "";

          const time = document.createElement("div");
          time.className = "time";
          time.textContent = formatStartTime(match.startTime);

          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = match.status || "";
          if (match.status === "LIVE") badge.classList.add("live");

          overlay.append(title, teams, event, time, badge);
          card.append(poster, overlay);
          return card;
        }

        // ðŸ”¹ Create Match Sections
        function createSection(titleText, matches) {
          const section = document.createElement("section");
          section.className = "movie-section";

          const title = document.createElement("div");
          title.className = "section-title";
          title.textContent = titleText;

          const container = document.createElement("div");
          container.className = "movie-container grid";

          matches.forEach((m) => container.appendChild(createMatchCard(m)));
          section.append(title, container);
          return section;
        }

        // ðŸ”¹ Load Matches (Optimized + fallback)
        async function loadMatches() {
          const urls = [
            "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.json",
            "https://api.codetabs.com/v1/proxy?quest=https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.json",
          ];

          allCategoriesContainer.innerHTML =
            "<div style='color:#bbb;text-align:center;margin:20px;'>Loading matches...</div>";

          for (const url of urls) {
            try {
              const res = await fetch(url + "?_=" + Date.now(), { cache: "no-store" });
              if (!res.ok) continue;
              const data = await res.json();
              const matches = data?.matches || [];
              renderMatches(matches);
              return;
            } catch (e) {
              console.warn("Retrying with backup URL...");
            }
          }

          allCategoriesContainer.innerHTML =
            "<div style='color:#ff7777;text-align:center;margin:20px;'>Failed to load matches.</div>";
        }

        // ðŸ”¹ Render Matches to Page
        function renderMatches(matches) {
          allCategoriesContainer.innerHTML = "";
          if (!matches.length)
            return (allCategoriesContainer.innerHTML =
              "<div style='color:#bbb;text-align:center;margin:20px;'>No matches available.</div>");

          const live = matches.filter((m) => m.status === "LIVE" && (m.adfree_url || m.dai_url));
          if (live.length) allCategoriesContainer.appendChild(createSection("Live Now", live));

          const categories = matches.reduce((a, m) => {
            if (m.status === "LIVE") return a;
            const c = m.event_category || "Other Events";
            (a[c] ||= []).push(m);
            return a;
          }, {});
          Object.keys(categories)
            .sort()
            .forEach((cat) => allCategoriesContainer.appendChild(createSection(cat, categories[cat])));
        }

        searchBar.addEventListener("input", () => {
          const query = searchBar.value.toLowerCase();
          document.querySelectorAll(".movie-card").forEach((c) => {
            const t = c.querySelector(".title")?.textContent.toLowerCase() || "";
            const e = c.querySelector(".event")?.textContent.toLowerCase() || "";
            c.style.display = t.includes(query) || e.includes(query) ? "flex" : "none";
          });
        });

        loadMatches();
        setInterval(loadMatches, 300000); // refresh every 5 mins
      });
    </script>
  </body>
</html>
